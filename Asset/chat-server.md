**نحوه اجرا**

با وارد کردن دستور زیر در پوشه اصلی پروژه ، فایل اجرایی کلاینت و سرور در محل فعلی ایجاد می­شود .

1. make

برای اجرای برنامه ابتدا سرور را اجرا مطابق دستور اول اجرا میکنیم و سپس کلاینت را اجرا میکنیم(حداکثر میتوانیم سه کلاینت همزمان اجرا کنیم)
برای اجرا کردن کلاینت باید نام کاربری را به عنوان آرگومان اول و آی پی و پورت سرور را به عنوان آرگومنت دوم به کلاینت بدهیم

1. ./chat-server.out 
2. ./chat-client.out [username] [ip]:[port]


**ساختار**

کد­های برنامه­ها در پوشه Source قرار گرفته است . این پوشه دارای سه پوشه دیگر است :

- Client : محتوی این پوشه شامل فایل­های مورد نیاز برای ایجاد برنامه client می­باشد
- Common : برخی فایل­های مشترک میان برنامه server و client در این پوشه جای گرفته است
- Server : فایل­های مورد نیاز برنامه server در این پوشه قرار دارد

**شرح کدها و عملکرد آنها**

**کلاس**  **Message**


این کلاس وظیفه تبدیل پکت های گرفته شده از طریق سوکت به پیام ها یا تبدیل پیام ها به پکت ها را دارد.

- Message(const char \*message) : این constructor پکت گرفته شده از سرور را میگیرد و type, id, length و payload آن را استخراج و ذخیره میکند.
- Message(MessageTypes type, short id, short length, const char \*message) : این constructor اطلاعات پیامی را که میخواهیم از طریف سوکت ارسال کنیم میگیرد و آرایه ای از کاراکترها را میسازد که ساختار اصلی پکت های ارسالی را دارد.

**کلاس**  **Server**

این کلاس مسئولیت ساخت و مدیریت سرور را دارد.


- void startServer() : این تایع وظیفه اجرای دو thread اصلی سرور گرفتن پیام و فرستادن پیام را دارد.
- void getMessage() : این تابع قدیمی ترین پیام گرفته شده را برا بررسی کردن آماده میکند و سپس آن را پاک میکند.
- void analyzeMessage(pair\<int, Message> &message) : این تابع پیامی که تابع getMessage آماده کرده است را میگیرد و با توجه به نوع آن، آن را به تابع های دیگر میدهد.
- void handleConnect(pair\<int, Message\> &message) : این تابع پیام هایی که نوع آن CONNECT است را میگیرد و کاربر را ذخیره میکند و پیامی از نوع CONNACK برای کلاینت میفرستد.
- void handleExit(pair\<int, Message\> &message) : این تابع پیام هایی که نوع آن EXIT است را میگیرد و کاربر را از لیست کاربرهای آنلاین خارج میکند و کانکشن را میبندد.
- void handleList(pair\<int, Message\> &message) : این تابع پیام هایی که نوع آن LIST است را میگیرد و پیامی جاوی آیدی کاربرهای آنلاین از نوع LISTREPLY برمیگرداند.
- void handleUserInfo(pair\<int, Message\> &message) : این تایع پیام هایی که نوع آن INFO است را میگیرد و نام کاربری متناسب با آیدی داده شده را در پیامی از نوع INFOREPLY به کاربر میفرستد.
- void handleSend(pair\<int, Message\> &message) : این تابع پیام هایی که نوع آن SEND است را میگیرد و در صورتی که کاربر هدف آنلاین باشد برای او پیامی از نوع RECEIVEREPLY میفرستد و برای کاربر مبدا هم پیامی از نوع SENDREPLY با وضعیت SUCCESS میفرستد و در صورتی که کاربر هدف آنلاین نباشد، پیام را ذخیره میکند تا بعد از آنلاین شدن برای او بفرستد و برای کاربر مبدا پیامی از نوع RECEIVEREPLY با وضعیت FAILURE میفرستد.
- void handleReceive(pair\<int, Message\> &message) : این تابع پیام هایی که نوع آن RECEIVE است را میگیرد و پیام های ذخیره شده برای کاربر (هنگامی که آفلاین بوده) را تک تک در پیامی از نوع RECEIVEREPLY میفرستد و به همراه آن نام کاربری کسی که پیام را فرستاده در پیامی از نوع INFOREPLY میفرستد.
- void sendUserInfo(int sock, char user\_id\_char\[2\], unsigned short message\_id) : این تابع برای فرستادن پیام ای برای کاربر است که نوع آن  INFOREPLY است.
- void receiveMessage(int socket) : این تابع پیام هایی که کاربر میفرستد را با استفاده از کلاس Message در صف ذخیره میکند.
- void acceptConnections() : این تابع کانکشن هایی که به سرور درخواست میدهد را ذخیره میکند و آن ها را برای ورودی جدید با استفاده از select چک میکند.
- unsigned short getId() : برای کاربرهای جدید که به سرور وصل میشوند آیدی ایجاد میکند. اولین آیدی برابر یک است.

**کلاس**  **Cient**

این کلاس مسئولیت ساخت و مدیریت کاربر را دارد.

- void startClient() : این تابع وظیفه اجرا کردن دو thread اصلی کاربر یعنی گرفتن پیام ها از سمت سرور و گرفتن ورودی از سمت کاربر را دارد.
- void sendInitialPackets() : این تابع در ابتدای ساخت کاربر یک پیام از نوع CONNECT برای ثبت شدن در سرور میفرستد و بعد از آن یک پیام از نوع RECEIVE برای گرفتن پیام هایی که آفلاین بوده است میفرستد.
- void getInputs() : این تابع ورودی را از کاربر میگیرد و با توجه به ورودی تابع مناسب را فرامیخواند.
- void handleList() : این تابع در صورتی که ورودی کاربر دستور list بوده باشد صدا زده میشود و پیامی از نوع LIST برای سرور میفرستد.
- void handleExit() : این تابع در صورتی که ورودی کاربر دستور exit بوده باشد صدا زده میشود و پیامی از نوع EXIT برای سرور میفرستد و از برنامه خارج میشود.
- void handleSend(int receiver\_id, string text) : این تابع در صورتی که ورودی کاربر دستور sebd بوده باشد صدا زده میشود و پیامی از نوع SEND برای سرور میفرستد.
- void getMessages() : این تابع پیام هایی که از طرف سرور فرستاده میشوند را مدیریت میکند.
- void handleListReply(Message &message) : در صورتی که پیام سرور از نوع LISTREPLY باشد این تابع صدا زده میشود و به ازای هر آیدی فرستاده شده از طرف سرور یک پیام از نوع INFO با آن آیدی برای سرور میفرستد تا نام کاربری را بگیرد.
- void handleInfoReply(Message &message) : در صورتی که پیام سرور از نوع INFOREPLY باشد این تابع صدا زده میشود و نام کاربری را نمایش میدهد.
- void handleReceiveReply(Message &message) : در صورتی که پیام سرور از نوع RECEIVEREPLY باشید این تابع صدا زده میشود و سپس نام کاربری فرستنده را از سرور میگیرد و آنها را نمایش میدهد.
- static unsigned short getMessageId() : این تابع برای گرفتن آیدی برای پیام جدید است.


