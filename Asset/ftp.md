**نحوه اجرا**

با وارد کردن دستور زیر در پوشه اصلی پروژه ، فایل اجرایی کلاینت و سرور در محل فعلی ایجاد می­شود .

1. make

ابتدا نیاز داریم سرور را اجرا کرده و سپس به سراغ کلاینت برویم . هر دو برنامه نیاز به آدرس فایل کانفیگ دارند که باید به صورت Programmer Argument به برنامه ها داده شوند . برای مثال اجرا برنامه­ها به صورت زیر است .

1. ./server.out Source/config.json
2. ./client.out Source/config.json

در صورتی که آدرس فایل کانفیگ وارد نشده یا اشتباه وارد شده باشد ، برنامه اروری به کاربر نمایش می­دهد و خاتمه پیدا می­کند .

**ساختار**

کد­های برنامه­ها در پوشه Source قرار گرفته است . این پوشه دارای سه پوشه دیگر است :

- Client : محتوی این پوشه شامل فایل­های مورد نیاز برای ایجاد برنامه client می­باشد
- Common : برخی فایل­های مشترک میان برنامه server و client در این پوشه جای گرفته است
- Server : فایل­های مورد نیاز برنامه server در این پوشه قرار دارد

**شرح کد**** ­ ****های سرور و عملکرد آن**** ­ ****ها**

**کلاس**  **Command**

این کلاس وظیفه بررسی دستورات وارد شده توسط کلاینت و پاسخ به آن­ها را دارد .

- bool verify(string msg, bool count) : در این تابع به طور کلی صحت ورودی دستور ورودی بررسی می­شود . این بررسی در دو حالت انجام می­گیرد . حالت اول بررسی موجود بودن دستور بدون توجه به دیگر پارامتر­های ورودی است . و در حالت دوم دستور با تعداد آرگومان­های آن بررسی می­شود که آیا تعداد آرگومان­ها با نوع دستور همخوانی دارند یا خیر .
- bool verify(string msg, string cmd, int count) : این تابع بررسی صحت دستور ورودی با دستوری که ما انتظار داریم را ارزیابی می­کند . همچنین تعداد آرگومان دستور در این تابع بررسی خواهد شد .
- bool verify(string msg, string cmd, string branch, int count) : این تابع نیز همانند تابع قبلی صحت ورودی را بررسی می­کند اما برای دستوراتی مانند دستور dele که دارای دو شاخته هستند کاربر بیشتری دارد .
- void enterCredential(string msg, User \*user) : در صورتی که یکی از دستورات user یا pass وارد شود ، این تابع فرخوانی خواهد شد و با ارسال دستور و کاربر مربوطه به این تابع ، مقادیر نام کاربری و کلمه عبور به آن کاربر اضافه خواهد شد .
- void response(int fd, int code) : این تابع وظیفه ارسال پاسخ دستوراتی که پاسخ آن­ها ثابت است را دارد . با دریافت File Descriptor کاربر و کد دستور ، پاسخ دستور به کاربر ارسال می­شود.
- void response(int fd, int code, string branch) : این تابع پاسخ دو دستور ls و retr را به دلیل مشابهت در کد پاسخ آن­ها به کاربر ارسال می­کند .
- void response(int fd, int code, string branch, string name) : در این تابع پاسخ به دستورات mkd ، pwd ، cwd ، rename و dele ارسال می­شود . این دستورات در پاسخ خود نام فایل یا پوشه­ای دارند که باید در پاسخ باشد . برای همین این تابع یک ورودی نام دارد .
- string getPath(string msg, int i) : به طوری کلی این تابع هر آرگومان از دستور را جدا می­کند و می­توان با دادن شماره آن را از این تابع دریافت کرد .

**کلاس**  **CommandExecutor**

در این کلاس دستوراتی که سیستمی هستند و با فایل­ها سر و کار دارد انجام می­شود .

- string pwd() : به کمک توابع کتابخانه ای لینوکس ، مسیر فعلی را به صورت یک رشته برمی­گرداند
- string cwd(string currentPath, string destination) : با گرفتن مسیر فعلی به مسیر مقصد می­رود و مسیر جدید را به صورت یک رشته برمی­گرداند . در صورتی که مسیر مقصد .. باشد به پوشه بالایی می­رود و این کار را تا زمانی انجام می­دهد که به مسیر / برسد . در صورتی که مسیر وارد شده .. نباشد بررسی می­کند آیا مسیر وارد شده صحیح است یا خیر ، درصورت صحیح بودن مسیر جدید را بر­می­گرداند و در غیر این صورت رشته ثابت ارور را می­دهد .
- bool mkd(string currentPath, string path) : این تابع در مسیر فعلی پوشه­ای یجاد می­کند . در صورتی که عملیات موفقیت آمیز باشد true و در غیر این صورت false می­دهد .
- bool dele(string currentPath, string branch, string name) : این تابع فایل­ها را به کمک توابع سیستمی لینوکس پاک می­کند که درصورت موفقت true و در غیر این صورت false برمی­گرداند . برای پاک کردن یک پوشه ابتدا به کمک تابع cwd از صحت وجود پوشه اطمینان حاصل می­کنم ، سپس به کمک تابع system و اجرا دستور rm با شاخه -rf در سیستم لینوکس ، پوشه مد نظر را پاک می­کنیم .
- string ls(string currentPath) : لیست فایل­ها و پوشه­های مسیر فعلی را در قالب یک رشته بر­می­گرداند .
- bool rename(string currentPath, string currentName, string afterName) : در مسیر فعلی ، نام فایلی را تغییر می­دهد و در صورت موفقیت true و در غیر این صورت false برمی­گرداند .
- string help() : راهنما برنامه را در قالب یک رشته برمی­گرداند .
- string getFileName(string path) : در صورتی که مسیری توسط کاربر وارد شده باشد که انتهای آن نام فایلی باشد ، این تابع نام فای را جدا کرده و برمی­گرداند .
- long getFileSize(string path) : این تابع حجم یک فایل را بر مبنی بایت برمی­گرداند . در صورتی که فایل وجود نداشته باشد ، -1 برگردانده می­شود .
- string getFileContent(string path) : در صورتی که نیاز به ارسال فایل به کلاینت باشد ، این تابع محتوی فایل را به صورت یک رشته در آورده و برمی­گرداند .

**کلاس**  **Data**

وظیفه ارسال داده در کانال داده به کاربران بر عهده این کلاس است .

- void response(int fd, string data) : این تابع File Descriptor کانال داده کاربر و دیتا مربوطه را گرفته و به کاربر ارسال می­کند .

**کلاس**  **Logger**

این کلاس وظیفه نمایش و ذخیره کردن رخداد­های برنامه را دارد . یک فایل با نام log.txt ساخته شده و در آن ذخیره می­شود .

- string getDateTime() : این تابع تاریخ و ساعت فعلی را در قالب یک رشته برمی­گرداند .
- void log(string username, string msg) : این تابع یک رشته رخداد تولید کرده و آن را در فایل رخداد­ها ذخیره کرده و آن را در کنسول سرور نمایش می­دهد . رخداد تولید شده دارای تاریخ و ساعت ، نام کاربری و عملیات انجام شده است .
- void log(string username, string msg, string argument) : این تابع یک رشته رخداد تولید کرده و آن را در فایل رخداد­ها ذخیره کرده و آن را در کنسول سرور نمایش می­دهد . رخداد تولید شده دارای تاریخ و ساعت ، نام کاربری ، عملیات انجام شده و نام پوشه یا فایل است .

**کلاس**  **Server**

این کلاس ، کلاس کلی و مدیریت کننده سرور ما می­باشد . پیاده سازی این کلاس به صورت Singletone است ، چرا که ما نباید بیش از یک نمونه از کلاس سرور در برنامه داشته باشیم .

در این کلاس کاربر­ها و فایل­های ادمین وجود دارد .

- int acceptClientCommand() : این تابع یک File Descriptor برای ارتباط در کانال دستور به کاربر اختصاص می­دهد .
- int acceptClientData() : این تابع یک File Descriptor برای ارتباط در کانال داده به کاربر اختصاص می­دهد .
- User \*findUser(int fd, fileDescriptor type, vector\<User \*\> \_users\_) : این تابع به دنبال کاربری با File Descriptor مشخصی در لیست ورودی می­گردد .
- User \*findUser(string username, vector\<User \*\> \_users\_) : این تابع به دنبال کاربری با نام­کاربری مشخص در لیست ورودی می­گردد .
- User \*findUser(string username, string password, vector\<User \*\> \_users\_): این تابع برای احراز هویت کاربر انجام می­شود . در این تابع بررسی می­کینم آیا کاربری با نام­کاربری و رمزعبور داده شده وجود دارد یا خیر .
- void removeUser(int fd, fileDescriptor type) : زمانی که کاربر از سامانه خارج شود ، کاربر به کمک این تابع از لیست حذف می­شود .
- bool canAccess(User \*user, string name) : در این تابع بررسی می­کینم آیا کاربر اجازه دسترسی به فایل مورد نظر را دارد یا خیر . ادمین بودن یا نبودن کاربر در این بررسی اهمیت دارد .
- void init(string path) : این کلاس با دریافت مسیر فایل کانفیگ ، داده­های مورد نیاز را به کمک کتابخانه متن باز json خوانده و در کلاس سرور ذخیره می­کند .
- void startServer() : در این کلاس دو کانال ارتباطی ، یکی برای دستور و دیگری برای داده ، ایجاد می­شود و File Descriptor آن­ها برای استفاده­های بعدی ذخیره می­شود .
- void listenCommand() : این کلاس نقطه ارتباط کانال دستور با کلاینت­ها است . در این تابع منتظر دریافت دستور از کاربران می­مانیم ، در صورتی که کاربر هنوز وارد نشده باشد ، در لیست newUsers قرار گرفته و File Descriptor به آن اختصاص داده می­شود و پس از ورودی موفقیت آمیز به لیستی اصلی کاربر­ها منتقل می­شود . این تابع به کمک فراخوانی سیستمی select ارتباط با چندید کلاینت را مدیریت می­کند . هر کاربر در یک مرحله است که جلوتر به توضیح مراحل خواهیم پرداخت . بر اساس مرحله کاربر ، پاسخ­ها و عملکرد سرور متفاوت خواهد بود . در صورتی که کاربر هنوز وارد نشده باشد ، پاسخ به بسیاری از دستورات او با ارور مواجه می­شود . به ازای هر دستور یک پاسخ ارسال و یک رخداد در سمت سرور ایجاد می­شود . نحوه عملکر ارسال پاسخ و ذخیره رخداد پیشتر توضیح داده شده است .

ارسال داده با توجه قراردادی بودن این ارتباط به این شرح است . خط اول داده نوع آن را مشخص می­کند . این نوع می­تواند نمایش در کنسول ، ذخیره به صورت فایل یا ارور باشد که این نوع در سمت کلاینت مورد استفاده قرار خواهد گرفت . در صورتی که نوع فایل باشد ، محل ذخیره و نام فایل در خط دوم خواهد آمد . در ادامه داده ارسالی ، فرستاده می­شود .

- void listenData() : این تابع منتظر برقراری ارتباط برای کانال داده است . سوکت کانال داده زمانی شکل می­گیرد که کاربر با موفقیت وارد شده باشد . قبل از این ، ارتباط کانال داده برقرار نیست. عملکر این تابع نیز مشابه تابع قبل است .

**کلاس**  **User**

این کلاس به عنوان یک کلاس جهت نگه­داری داده­های هر کاربر استفاده می­شود .

این کلاس حاوی نام­کاربری ، کلمه عبور ، ادمین بودن یا نبودن ، حجم کاربر ، مسیر فعلی کاربر ، مرحله کاربر و File Descriptor دستورات و داده­ها است .

مرحه یک کاربر عبارت است از :

- ENTER\_USER : این مرحله ، مرحله ابتدایی هر کاربر است که منتظر ورودی نام­کاربری هستیم
- ENTER\_PASSWORD : این مرحله پس از ورود نام­کاربری است و منتظر وارد کردن کلمه عبور هستیم . در صورتی که نام­کاربری و رمز عبور درست باشد به مرحله LOGGED\_IN می­رویم ، در غیر این صورت به مرحه ENTER\_USER می­رویم .
- LOGGED\_IN : در این مرحه کاربر وارد سامانه شده است و می­تواند بقیه دستورات را وارد کند . کاربر با وارد کردن دستور quit به مرحله ENTER\_USER می­رود .

**فایل**  **main**

در این فایل تابع init سرور صدا می­شود تا سرور پیکربندی شود سپس در صورت پیکربندی صحیح ، سرور شروع به کار می­کند . در این تابع دو Thread جدید به برنامه اضافه می­شود . یکی برای دریافت دستورات کانال دستور و دیگری برای دریافت درخواست اتصال کانال داده . دلیل استفاده از دو Threadدریافت همزمان دستور و درخواست اتصال کانال داده است .

**شرح کد**** ­ ****های کلاینت و عملکرد آن**** ­ ****ها**

**کلاس**  **Client**

پیاده سازی این کلاس به صورت Singletone است ، چراکه نباید بیش از یک نمونه از کلاس کلاینت در برنامه موجود باشد . در این کلاس نام­کاربری و کلمه عبور کاربر به همراه File Descriptor کانال داده و دستور ذخیره می­شود .

- int connectServer(int port) : این تابع با دریافت پورت ، به سرور مربوطه وصل می­شود و File Descriptor را برمی­گرداند .
- bool responseCode(string msg, int code) : این تابع کد پاسخ کانال دستور را با کد مورد نظر مقایسه و نتیجه برابر بودن یا نبودن را برمی­گرداند .
- void receiveDataResponse() : این تابع پاسخ کانال داده را دریافت و تفسیر می­کند . در صورتی که نوع داده نمایش در کنسول باشد ، در کنسول نمایش می­دهد و در صورتی که فای باشد، فایلی در مسیر فعلی با نام مشخص ساخته و محتوی دریافتی را در آن ذخیره می­کند . سپس به دریافت پاسخ از کانال دستور می­پردازد .
- void init(string path) : این تابع با ورودی گرفتن آدرس فایل کانفیگ پورت اتصال کانال داده و دستور را به کمک کتابخانه متن باز json خوانده و ذخیره می­کند .
- void startCommand() : این تابع ، تابع connectServer را با پورت کانال دستور صدا می­زند و File Descriptor کانال دستور را ذخیره می­کند .
- void startData() : این تابع زمانی صدا زده می­شود که نام­کاربری و کلمه­عبور کاربر تاییده شده باشد . این تابع نام­کاربری و کلمه­عبور کاربر را به کانال دستور ارسال می­کند تا ارتباط برقرار شود .
- void sendCommand() : این تابع ، ورودی کاربر را از کنسول خوانده و به سرور ارسال می­کند، این تابع همچنان نام­کاربری و کلمه­عبور کاربر را ذخیره می­کند . در انتها برای دستوراتی که نیاز به پاسخ در کانال داده باشد ، ادامه کار را به تابع receiveDataResponse محول می­کند .
- void receiveCommandResponse() : این تابع پاسخ دریافتی در کانال دستور را از سرور دریافت و در کنسول چاپ می­کند . همچنین با بررسی پاسخ دستور ، در صورت صحت نام­کاربری و کلمه­عبور ارتباط برای برقراری ارتباط کانال داده اقدام می­کند و در صورت دریافت پاسخ دستور quit برنامه را خاتمه می­دهد .

**فایل**  **main**

در تابع اصلی این فایل پس از صحت پیکربندی ، حلقه از ارسال و دریافت دستورات شکل می­گیرد .